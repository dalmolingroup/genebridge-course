---
title: "Plotting Abundance"
author: "Dalmolin Systems Biology Group"
format: html
execute: 
  cache: true
---

```{r setup3, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  results = FALSE
)
```

## Importing libraries

```{r libs}
library(here)
library(readr)
library(magrittr)
library(ggplot2)
library(hrbrthemes)
library(tinter)
library(dplyr)
library(tidyr)
library(AnnotationHub)
```

## Defining Functions

The purpose of these functions is to organize the vertex annotations in our `nodelist` and to calculate the cumulative number of genes by clade and by biological process.

```{r}
calculate_cumulative_genes <- function(nodelist) {
  
  # Get all possible categories of clade_name
  all_clades <- node_annotation %>%
    arrange(desc(root)) %>%
    dplyr::select(clade_name) %>%
    unique()
  
  # Define the columns of interest
  process_columns <- c("queryItem", "root", "clade_name", 
                       "Olfactory transduction", 
                       "Taste transduction",         
                       "Phototransduction")
  
  # Calculate the cumulative sum, grouping by clade_name
  cumulative_genes <- nodelist %>%
    arrange(desc(root)) %>%
    dplyr::select(all_of(process_columns)) %>%
    group_by(clade_name, root) %>%
    summarise(count_genes = n(), .groups = "drop") %>%
    arrange(desc(root)) %>%
    mutate(cumulative_sum = cumsum(count_genes)) %>%
    right_join(all_clades, by = "clade_name") %>%
    fill(cumulative_sum, .direction = "down")
  
  return(cumulative_genes)
}

calculate_cumulative_bp <- function(nodelist) {
    
  # Get all possible categories of clade_name
  all_clades <- node_annotation %>%
    arrange(desc(root)) %>%
    dplyr::select(clade_name) %>%
    unique()
  
  # Define the columns of interest
  process_columns <- c("queryItem", "root", "clade_name", 
                       "Olfactory transduction", 
                       "Taste transduction",         
                       "Phototransduction")
  
  # Calculate the cumulative sum for each biological process
  cumulative_bp <- nodelist %>%
    dplyr::select(all_of(process_columns)) %>%
    distinct(root, queryItem, .keep_all = TRUE) %>%
    mutate(across(all_of(process_columns[-c(1:3)]), ~ as.numeric(.))) %>%
    group_by(root, clade_name) %>%
    summarise(across(all_of(process_columns[-c(1:3)]), 
                     ~ sum(. , na.rm = TRUE)),
              .groups = "drop") %>%
    arrange(desc(root)) %>%
    mutate(across(all_of(process_columns[-c(1:3)]), ~ cumsum(.))) %>%
    right_join(all_clades, by = "clade_name") %>%
    fill(everything(), .direction = "down")
  
  return(cumulative_bp)
}
```

## Defining Aesthetic Parameters for ggplot

Assigning default colors for the metabolic pathways in the analysis and defining the other aesthetic standards for plotting.

```{r}
# Plotting colors and labels
annotation_colors <- c(
  "Olfactory transduction"   = "#8dd3c7"
  ,"Taste transduction"      = "#72874EFF"
  ,"Phototransduction"       = "#fb8072"
)

annotation_labels <- c(
  "Olfactory transduction"   = "Olfactory transduction"
  ,"Taste transduction"      = "Taste transduction"
  ,"Phototransduction"       = "Phototransduction"
)

# This vertical line indicates the first metazoan (Amphimedon queenslandica / Ctenophora)
choanoflagellata_line <- geom_vline(
  xintercept = "Sphaeroforma arctica"
  ,color      = "#FF0000"
  ,linetype   = "11"
  ,alpha      = 1
  ,linewidth  = 0.25
)

# Plotting
theme_main <- theme(
  panel.spacing      = unit(2.5, "pt")
  ,strip.background   = element_blank()
  ,panel.grid.major.x = element_blank()
  ,panel.grid.major.y = element_line(linewidth = 0.25, linetype = "dotted", color = "#E0E0E0")
  ,strip.text.x       = element_text(size = 9, angle = 90, hjust = 0, vjust = 0.5, color = "#757575")
  ,strip.text.y       = element_text(size = 10, angle = 0, hjust = 0, vjust = 0.5, color = "#757575")
  ,axis.title         = element_text(size = 15, color = "#424242")
  ,axis.ticks.x       = element_blank()
  ,axis.text.x        = element_blank()
  ,axis.text.y        = element_text(size = 5.5)
  ,legend.position    = "none"
)

theme_supplementary <- theme(
  panel.grid.major.x = element_line(color = "#E0E0E0", linewidth = 0.25, linetype = "dotted")
  ,panel.grid.major.y = element_blank()
  ,strip.text.y       = element_text(size = 7, angle = 0, hjust = 0, vjust = 0.5, color = "#757575")
  ,strip.text.x       = element_text(size = 7, angle = 90, hjust = 0, vjust = 0.5, color = "#757575")
  ,axis.title         = element_text(size = 12, color = "#424242")
  ,axis.ticks         = element_line(colour = "grey20")
  ,axis.text.y        = element_text(size = 6, angle = 0, hjust = 1, vjust = 0.5, color = "#757575")
  ,axis.text.x        = element_text(size = 6)
)

theme_average <- theme(
  panel.spacing      = unit(1, "pt")
  ,axis.title         = element_text(color = "#424242")
  ,axis.text          = element_text(color = "#757575")
  ,axis.text.x        = element_text(size = 7, angle = -45, vjust = 0, hjust = 0)
  ,axis.text.y        = element_text(size = 5)
  ,strip.background   = element_blank()
  ,strip.text         = element_text(color = "#757575")
  ,strip.text.y       = element_text(angle = 0, hjust = 0, vjust = 0.5)
)

theme_big <- theme(
  panel.spacing      = unit(0.5, "pt")
  ,panel.grid.major.x = element_line(linewidth = 0.1, linetype = "dashed")
  ,panel.grid.major.y = element_blank()
  ,strip.background   = element_blank()
  ,strip.text.x       = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0)
  ,strip.text.y       = element_text(size = 8, angle = 0, hjust = 0, vjust = 0.5)
  ,axis.text.x        = element_text(size = 6, angle = 90, vjust = 0, hjust = 0)
  ,axis.text.y        = element_text(size = 4.5)
  ,axis.ticks         = element_line(size = 0.1)
)

tick_function <- function(x) {
  seq(x[2], 0, length.out = 3) %>% head(-1) %>% tail(-1) %>% { ceiling(./5)*5 }
}

```

## Loading Necessary Tables

To proceed with the analysis, it is necessary to load a table containing the *taxid* information for each species. This information will later be used to map the species' *taxids* with the *taxids* of each COG.

### Table Description

-   **File Name**: `string_eukaryotes.rda`
-   **Content**: Taxonomic information for eukaryotic species.

The table loads the following main fields:
-   **TaxID** (*taxonomic identifier*): A unique identifier associated with each species.
-   Species name

```{r}
# Query Phylotree and OG data
#ah <- AnnotationHub()
#meta <- query(ah, "geneplast")
#load(meta[["AH83116"]])

nodelist <- vroom::vroom(file = here("data/nodelist.csv"), delim = ",")
gene_cogs <-  vroom::vroom(file = here("data/gene_cogs.csv"), delim = ",")
sensorial_genes <- read.csv("../data/sensorial_genes.csv")
map_ids <- vroom::vroom("../data/map_ids.csv")
groot_df <- vroom::vroom("../data/groot_df.csv")

ogr <- readRDS("../data/ogr.RData")

load("../data/string_eukaryotes.rda")
head(string_eukaryotes)
```

## Visualization: Rooting Pattern

This visualization allows for the analysis of the cumulative pattern of gene emergence over evolutionary time. Additionally, it shows the growth of biological processes, separated by each metabolic pathway.

### Graph Characteristics

1.  **Bar Chart (Cumulative Pattern)**:
    -   Represents the cumulative sum of genes associated with each clade.
    -   Each bar displays the total accumulated genes in a given clade, allowing for the identification of the diversification pattern.
2.  **Combined Chart (Bars and Lines)**:
    -   The bars indicate the cumulative sum of genes per clade.
    -   The lines represent the growth of different biological processes (*Process*), separated by metabolic pathways, allowing for a comparison between the cumulative emergence of genes and the development of biological functions.

### Interpretation

-   **Cumulative Pattern**: The bar chart shows how genes have emerged cumulatively over time. This perspective helps to identify moments of greater genetic diversification.
-   **Comparison by Biological Processes**: The combined chart allows us to observe which biological processes stand out at different moments in evolution and how they are related to the emergence of new genes.

```{r}
# Mapping roots and proteins info
node_annotation <- nodelist %>%
  inner_join(gene_cogs, by = c("node" = "protein_id", "cog_id")) %>%
  inner_join(sensorial_genes, by = c("queryItem" = "gene_symbol")) %>%
  distinct(queryItem, cog_id, pathway_name, root, clade_name)

cumulative_genes <- calculate_cumulative_genes(nodelist) 
cumulative_bp <- calculate_cumulative_bp(nodelist)
  
cumulative_data <- left_join(cumulative_genes, cumulative_bp)
 

long_data <- cumulative_data %>%
  pivot_longer(cols = 5:7, 
               names_to = "Process", 
               values_to = "Value")

ggplot() +

  geom_bar(data = cumulative_data, 
           aes(x = factor(clade_name, levels = clade_name), y = cumulative_sum), 
           stat = "identity", fill = "darkgray", colour = NA) +
  geom_text(data = cumulative_data, 
            aes(x = factor(clade_name, levels = clade_name), y = cumulative_sum, label = cumulative_sum), 
            vjust = -0.5, size = 3, color = "darkgray") +
  scale_color_manual(values = annotation_colors) +
  
  labs(x = "Clade Name", y = "Cumulative Sum", 
       title = "Cumulative Sum and Biological Processes",
       fill = "Cumulative Sum",
       color = "Biological Processes") +
  
  theme_main +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot() +

  geom_bar(data = cumulative_data, 
           aes(x = factor(-root), y = cumulative_sum), 
           stat = "identity", fill = "darkgray", colour = NA) +
  geom_text(data = cumulative_data, 
            aes(x = factor(-root), y = cumulative_sum, label = cumulative_sum), 
            vjust = -0.5, size = 3, color = "darkgray") +
  

  geom_line(data = long_data, 
            aes(x = factor(-root), y = Value, color = Process, group = Process), 
            size = 1) +
  

  scale_color_manual(values = annotation_colors) +
  
  labs(x = "Clade Name", y = "Cumulative Sum", 
       title = "Cumulative Sum and Biological Processes",
       fill = "Cumulative Sum",
       color = "Biological Processes") +
  
  theme_main +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#ggsave(file = "", plot=a, width=15, height=8)
#ggsave(file = "", plot=b, width=15, height=8)
```

## Hipergeometric Test

The hypergeometric test is a statistical method used to determine if a set of genes of interest (in this case, genes from a specific clade) is significantly enriched with genes from a certain functional category (a biological process, such as "Olfactory transduction").

Essentially, this test answers the question: "Is the frequency of genes for a certain function within this evolutionary group higher than we would expect by random chance?". A significant result (low p-value) suggests that the increase in these genes was a relevant evolutionary event for that clade, linking gene expansion to the development of a specific biological capability.

```{r}
 clades <- unique(nodelist$clade_name)
 processes <- c("Olfactory transduction", "Taste transduction", "Phototransduction" )
   
  
   result <- list()
   
   for (process in processes) {
     for (clade in clades) {
       
       N <- length(unique(sensorial_genes$gene_symbol))  
       M <- sum(sensorial_genes$pathway_name == process)  
       n <- length(which(nodelist$clade_name == clade))  
       k <- sum(filter(nodelist, clade_name == clade)[[process]])  
       
       p_valor <- 1 - phyper(k - 1, M, N - M, n)
       
       result[[paste(process, clade, sep = "_")]] <- c(process, clade, k, M, N, n, p_valor)
     }
   }
   
   hipergeometric_df <- do.call(rbind, result) %>%
     as.data.frame() %>%
     setNames(c("Process", "clade_name", "k", "M", "N", "n", "p.val")) %>% 
     arrange(p.val)
   
     rownames(hipergeometric_df) <- NULL
   
   hipergeometric_df <- hipergeometric_df %>%
  mutate(across(all_of(c("k", "M", "N", "n", "p.val")), as.numeric))
     
   head(hipergeometric_df)
```

## Results Visualization

The code generates a bubble chart to visualize the analysis results:

Axes: The Y-axis shows the clades (evolutionary groups), and the X-axis shows the biological processes.

Point Size: The size of each point is proportional to the number of sensory genes found in that clade.

Point Color: The color highlights whether the functional enrichment was statistically significant (red) or not (gray).

```{r}
hipergeometric_df$p.val_color <- ifelse(hipergeometric_df$p.val > 0.05, "gray", "red")

i <- nodelist %>% 
  dplyr::select(clade_name, root) %>% 
  unique()

hipergeometric_df <- hipergeometric_df %>%
  inner_join(i, by = "clade_name")

hipergeometric_df$clade_name <- factor(hipergeometric_df$clade_name, 
    levels = unique(hipergeometric_df$clade_name[order(hipergeometric_df$root)]))


hipergeometric_df$Process <- factor(hipergeometric_df$Process, 
                                    levels = c("Olfactory transduction",
                                               "Taste transduction", 
                                               "Phototransduction" ))

ggplot(hipergeometric_df, aes(x = Process, 
                              y = clade_name, 
                              size = as.numeric(n), 
                              color = p.val_color)) +
  geom_point() +
  scale_color_manual(values = c("gray" = "gray", "red" = "red"), 
                     labels = c("Not Significant", "Significant")) +  
  labs(x = "Biological Process", y = "Clade", size = "Number of Genes", color = "Significance") +
  scale_size_continuous(breaks = c(1, 20, 40), labels = c("1 genes", "20 genes", "40 genes")) + 
  theme_minimal() +
  ggtitle("Hipergeometric Test") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank()) +
  theme(axis.text.y = ggtext::element_markdown())
```